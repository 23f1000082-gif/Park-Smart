{% extends "base.html" %} {% block title %}Find Parking{% endblock %} {% block
content %}
<style>
  .btn:hover {
    background-color: rgb(72, 66, 66);
  }
</style>

<div class="text-center mb-4">
  <h2>Available Parking Lots</h2>
  <button
    class="btn text-white mt-2"
    data-bs-toggle="modal"
    data-bs-target="#searchModal"
  >
    Search Spots
  </button>
</div>

{% if lots %}
<div class="row row-cols-1 row-cols-md-2 g-4">
  {% for lot in lots %}
  <div class="col">
    <div class="card lot-modern-card shadow-sm h-100 border-0 p-0">
      <div class="card-body d-flex flex-column justify-content-between p-4">
        <div>
          <div class="fw-bold fs-5 mb-1">{{ lot[1] }}</div>
          <div class="text-secondary small mb-3">
            {{ lot[2] }}, {{ lot[3] }}
          </div>
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center gap-1 text-secondary">
              <i class="bi bi-clock"></i>
              <span class="fw-semibold text-light">â‚¹{{ lot[4] }}</span
              ><span class="small ms-1">/hour</span>
            </div>
            <div class="d-flex align-items-center gap-1">
              <i class="bi bi-people-fill text-success"></i>
              <span class="fw-semibold text-success">{{ lot[6] }}</span>
              <span class="text-secondary small">/ {{ lot[5] }} spots</span>
            </div>
          </div>
        </div>
        <div>
          {% if lot[-1] == 'frozen' %}
          <span class="badge bg-warning mb-2">Frozen</span>
          <button
            class="btn btn-secondary w-100 mt-2 fw-semibold py-2"
            disabled
          >
            Booking Frozen
          </button>
          {% elif lot[6] > 0 %}
          <button
            class="btn text-white w-100 mt-2 fw-semibold py-2"
            style="background-color: rgb(210, 127, 43)"
            data-bs-toggle="modal"
            data-bs-target="#bookModal{{ lot[0] }}"
          >
            Book Now
          </button>
          {% else %}
          <button
            class="btn btn-secondary w-100 mt-2 fw-semibold py-2"
            disabled
          >
            No Spots Available
          </button>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  {% if lot[-1] != 'frozen' %}

  <div
    class="modal fade"
    id="bookModal{{ lot[0] }}"
    tabindex="-1"
    aria-labelledby="bookModalLabel{{ lot[0] }}"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-white">
        <form
          action="/book"
          method="POST"
          onsubmit="return validateBookingForm({{ lot[0] }})"
        >
          <div class="modal-header border-0">
            <h5 class="modal-title" id="bookModalLabel{{ lot[0] }}">
              Book Parking Spot - {{ lot[1] }}
            </h5>
            <button
              type="button"
              class="btn-close btn-close-white"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="lot_id" value="{{ lot[0] }}" />
            <div class="mb-3">
              <label class="form-label">Booking Type</label><br />
              <input
                type="radio"
                name="booking_type{{ lot[0] }}"
                value="now"
                checked
                onchange="toggleBookingFields({{ lot[0] }})"
              />
              Now
              <input
                type="radio"
                name="booking_type{{ lot[0] }}"
                value="later"
                onchange="toggleBookingFields({{ lot[0] }})"
              />
              Later
              <input
                type="hidden"
                name="booking_type"
                id="bookingTypeInput{{ lot[0] }}"
                value="now"
              />
            </div>
            <div id="bookNowFields{{ lot[0] }}" class="mb-3">
              <label>Duration (hours)</label>
              <input
                type="number"
                class="form-control bg-dark text-white border-secondary"
                name="duration"
                min="1"
                required
              />
            </div>
            <div id="bookLaterFields{{ lot[0] }}" class="mb-3 d-none">
              <label>Parking Time</label>
              <input
                type="datetime-local"
                class="form-control bg-dark text-white border-secondary"
                name="parking_time"
                id="parkingTime{{ lot[0] }}"
              />
              <label class="mt-2">Leaving Time</label>
              <input
                type="datetime-local"
                class="form-control bg-dark text-white border-secondary"
                name="leaving_time"
                id="leavingTime{{ lot[0] }}"
              />
              <div
                class="text-danger mt-1"
                id="dateError{{ lot[0] }}"
                style="display: none"
              >
                Leaving time must be after parking time.
              </div>
            </div>
          </div>
          <div class="modal-footer border-0">
            <button type="submit" class="btn btn-primary">Book</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %} {% endfor %}
</div>
{% else %}
<div class="alert alert-info mt-4">No parking lots available.</div>
{% endif %}

<div
  class="modal fade"
  id="searchModal"
  tabindex="-1"
  aria-labelledby="searchModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-white">
      <form method="POST">
        <div class="modal-header border-0">
          <h5 class="modal-title" id="searchModalLabel">
            Search Parking Spots
          </h5>
          <button
            type="button"
            class="btn-close btn-close-white"
            data-bs-dismiss="modal"
          ></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Pin Code</label>
              <input
                type="text"
                class="form-control bg-dark text-white border-secondary"
                name="pin_code"
                id="pinCodeInput"
                required
              />
            </div>

            <div class="col-md-4">
              <label class="form-label">Location</label>
              <select
                name="location"
                class="form-control bg-dark text-white border-secondary"
                id="locationSelect"
                required
              >
                <option value="">-- Select Location --</option>
              </select>
            </div>
          </div>

          <!-- <div id="bookNowFields" class="mt-3">
            <label>Duration (hours)</label>
            <input type="number" class="form-control" name="duration" min="1" />
          </div> -->

          <!-- <div id="bookLaterFields" class="mt-3 d-none">
            <label>Parking Time</label>
            <input
              type="datetime-local"
              class="form-control"
              name="parking_time"
            />
            <label>Leaving Time</label>
            <input
              type="datetime-local"
              class="form-control"
              name="leaving_time"
            />
          </div> -->
        </div>
        <div class="modal-footer border-0">
          <button type="submit" class="btn btn-dark">Search</button>
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  function toggleBookingFields(lotId) {
    const nowFields = document.getElementById("bookNowFields" + lotId);
    const laterFields = document.getElementById("bookLaterFields" + lotId);
    const bookingTypeInputs = document.getElementsByName(
      "booking_type" + lotId
    );
    let selected = "now";
    for (const input of bookingTypeInputs) {
      if (input.checked) selected = input.value;
    }
    document.getElementById("bookingTypeInput" + lotId).value = selected;
    if (selected === "now") {
      nowFields.classList.remove("d-none");
      laterFields.classList.add("d-none");

      nowFields.querySelector('input[name="duration"]').required = true;
      document.getElementById("parkingTime" + lotId).required = false;
      document.getElementById("leavingTime" + lotId).required = false;
    } else {
      nowFields.classList.add("d-none");
      laterFields.classList.remove("d-none");

      nowFields.querySelector('input[name="duration"]').required = false;
      document.getElementById("parkingTime" + lotId).required = true;
      document.getElementById("leavingTime" + lotId).required = true;
    }
  }

  function validateBookingForm(lotId) {
    const bookingType = document.getElementById(
      "bookingTypeInput" + lotId
    ).value;
    if (bookingType === "later") {
      const parkingTime = document.getElementById("parkingTime" + lotId).value;
      const leavingTime = document.getElementById("leavingTime" + lotId).value;
      const errorDiv = document.getElementById("dateError" + lotId);
      if (parkingTime && leavingTime && leavingTime <= parkingTime) {
        errorDiv.style.display = "block";
        return false;
      } else {
        errorDiv.style.display = "none";
      }
    }
    return true;
  }

  document
    .getElementById("pinCodeInput")
    .addEventListener("input", function () {
      const pin = this.value;
      const locationSelect = document.getElementById("locationSelect");

      if (pin.length >= 4) {
        fetch(`/get_locations/${pin}`)
          .then((res) => res.json())
          .then((data) => {
            locationSelect.innerHTML =
              '<option value="">-- Select Location --</option>';
            data.locations.forEach((loc) => {
              const option = document.createElement("option");
              option.value = loc;
              option.textContent = loc;
              locationSelect.appendChild(option);
            });
          });
      } else {
        locationSelect.innerHTML =
          '<option value="">-- Select Location --</option>';
      }
    });
</script>

{% endblock %}
